name: Deploy PFFL Backend 

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy Staging
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: SSH into Staging Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 3.236.28.26
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY_STAGING }}
          port: 22
          script: |
            # --- 1. Load NVM (Node Version Manager) ---
            # This is required because non-interactive SSH doesn't load .bashrc automatically
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            cd /home/ubuntu/pfflbackendbilal
            git pull origin staging
            npm install --save-dev typescript @types/react @types/node
            npm run build
            pm2 delete pffl-backend || true
            pm2 start "npm run start" --name pffl-backend
            pm2 save

  deploy-prod:
    name: Deploy Main
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: SSH into Main Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 100.24.126.221
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          port: 22
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  
            # --- MAIN DEPLOYMENT LOGIC ---
            # Update this path to your production folder
            cd /home/ubuntu/pfflbackendbilal
            
            git pull origin main
            
            # Standard install for main (usually --production)
            npm install --save-dev typescript @types/react @types/node
            npm run build
            
            # Ensure the PM2 name is distinct if on the same server
            pm2 delete pffl-backend || true
            pm2 start "npm run start" --name pffl-backend
            pm2 save
